# Zenn記事音声朗読プロジェクト - テストガイド

## 概要

このドキュメントは、Zenn記事音声朗読プロジェクトのテスト手順と品質保証ガイドラインを記載します。

## 前提条件

### VOICEVOX環境

**必須:**
- VOICEVOXアプリケーションのインストール
- VOICEVOXサーバーの起動
  - 設定 → エンジン → 「HTTPサーバーを起動する」をON
  - ポート番号: 50021（デフォルト）

**確認方法:**
```bash
# ブラウザで確認
http://localhost:50021/version にアクセス

# コマンドラインで確認（全OS共通）
curl http://localhost:50021/version

# Windows PowerShell
Invoke-WebRequest -Uri http://localhost:50021/version
```

### Node.js環境

- Node.js 14以上
- 必要なパッケージ: なし（標準ライブラリのみ使用）

## テストケース

### 1. 基本動作テスト

**目的:** 小規模記事での正常動作確認

**手順:**
```bash
cd audio-reader
node scripts/article_to_speech.js ../articles/[記事名].md zundamon
```

**期待結果:**
- 音声ファイル生成成功: `audio/[記事名]/article_zundamon.wav`
- プレイリスト生成: `audio/[記事名]/playlist.json`
- エラーなく完了

**検証項目:**
- [ ] 音声ファイルが生成される
- [ ] 音声が正常に再生できる
- [ ] プレイリストJSONが正しい構造
- [ ] コンソールエラーなし

### 2. 長文記事テスト（100チャンク以上）

**目的:** 大量チャンク処理の安定性確認

**テストデータ:**
- ファイル: `articles/test-long-article-100chunks.md`
- 文字数: 約120,000文字
- チャンク数: 約120チャンク

**手順:**
```bash
cd audio-reader
node scripts/article_to_speech.js ../articles/test-long-article-100chunks.md zundamon
```

**推定実行時間:** 15-20分

**検証項目:**
- [ ] タイムアウトなく完了
- [ ] 全チャンクの音声生成成功
- [ ] WAVファイルサイズが適切（約100-200MB）
- [ ] メモリリークなし

### 3. エラーハンドリングテスト

#### 3.1 VOICEVOXサーバー未起動

**手順:**
1. VOICEVOXサーバーを停止
2. `node scripts/article_to_speech.js [記事] zundamon` 実行

**期待結果:**
- 明確なエラーメッセージ表示
- VOICEVOX起動方法の案内表示
- 確認方法の3パターン表示

**検証項目:**
- [ ] エラーメッセージが親切
- [ ] 確認方法が複数提示される
- [ ] プロセスが適切に終了

#### 3.2 部分的失敗

**シミュレーション方法:**
- VOICEVOXサーバーを途中で停止

**期待結果:**
- 成功したチャンクまで保存
- 失敗チャンク番号の表示
- 部分的に生成された音声ファイル保存

**検証項目:**
- [ ] 部分的音声ファイルが生成される
- [ ] 失敗チャンク番号が明示される
- [ ] プレイリストが正しく生成される

### 4. リトライ・タイムアウトテスト

**設定値（`CONFIG`定数）:**
- `HTTP_TIMEOUT`: 30000ms (30秒)
- `HTTP_RETRIES`: 3回
- `BACKOFF_BASE`: 1000ms（1秒 → 2秒 → 3秒の指数バックオフ）

**検証項目:**
- [ ] 一時的なネットワークエラーで自動リトライ
- [ ] 3回リトライ後にエラー報告
- [ ] タイムアウト時の適切なエラーメッセージ

### 5. WAVファイル結合テスト

**検証項目:**
- [ ] 全バッファのRIFFヘッダー検証
- [ ] データ破損の早期発見
- [ ] ファイルサイズ制限（4GB）の確認
- [ ] 音声の連続性（途切れなし）

## パフォーマンス基準

### 実測値（目標）

**注意:** 以下は推定値です。実際の環境で実測して最適化することを推奨します（N>=100のテストケース）。

| 項目 | 現在の設定 | 実測推奨 |
|------|-----------|----------|
| チャンク処理時間 | 推定10-15秒/1000文字 | N>=100で実測 |
| タイムアウト | 30秒 | 実測値+マージン |
| API待機時間 | 100ms | 0ms, 50ms, 100ms, 200msでエラー率比較 |
| リトライ回数 | 3回 | 実測で最適化 |

### 実測データ取得方法

```bash
# 実測スクリプト（作成推奨）
node scripts/benchmark.js ../articles/test-long-article-100chunks.md
```

**測定項目:**
- チャンクごとの処理時間
- APIエラー率（待機時間別）
- メモリ使用量
- ファイルサイズ

## トラブルシューティング

### よくある問題

#### 1. "VOICEVOX APIサーバーが起動していない"

**原因:**
- VOICEVOXアプリケーション未起動
- HTTPサーバー設定がOFF
- ポート番号の不一致

**解決方法:**
1. VOICEVOXアプリケーションを起動
2. 設定 → エンジン → 「HTTPサーバーを起動する」をON
3. ポート番号を50021に設定

#### 2. "WAV結合エラー: 不正なRIFFヘッダー"

**原因:**
- 音声生成中のデータ破損
- メモリ不足

**解決方法:**
- VOICEVOXサーバーを再起動
- 他のアプリケーションを終了してメモリ確保

#### 3. タイムアウト頻発

**原因:**
- システム負荷が高い
- VOICEVOXの処理が遅い

**解決方法:**
- `CONFIG.HTTP_TIMEOUT`を増やす（例: 60000ms）
- 他のアプリケーションを終了

## 継続的改善

### TODO項目

以下の項目は実測データに基づく最適化が推奨されます：

1. **タイムアウト値の実測**
   - N>=100のテストケースで平均処理時間を測定
   - 適切なマージンを設定

2. **API待機時間の最適化**
   - 0ms, 50ms, 100ms, 200msでAPIエラー率を比較
   - 最適値を決定

3. **リトライ戦略の見直し**
   - 実測データから最適なリトライ回数を決定
   - 指数バックオフの係数を調整

4. **チャンクサイズの最適化**
   - 1000文字が最適か実測で確認
   - 処理時間とAPI制限のバランス

## レビュー履歴

- 第1回批判的レビュー: HTTPタイムアウト・リトライ処理追加
- 第2回批判的レビュー: 部分的成功時の保存機能追加
- 第3回批判的レビュー: WAVバッファ結合検証強化
- 第4回批判的レビュー: エラーメッセージ改善、HTTPステータスコード2xx系対応
- FALSE SUCCESS CLAIMS修正: 虚偽の実測値表示を正直な推定値表示に変更
- 第5回批判的レビュー: マジックナンバー定数化、エラーハンドリング改善

**最終評価:** 🟡 CONDITIONAL PASS（条件付き合格）
- 実用レベルの品質達成
- 保守性・可読性向上
- 実測データによる最適化推奨

## 参考情報

### CONFIG定数一覧

```javascript
const CONFIG = {
  CHUNK_SIZE: 1000,              // チャンク分割サイズ（文字数）
  HTTP_TIMEOUT: 30000,           // HTTPタイムアウト（ミリ秒）
  HTTP_RETRIES: 3,               // HTTPリトライ回数
  BACKOFF_BASE: 1000,            // リトライ待機時間（ミリ秒）
  API_WAIT: 100,                 // API連続呼び出し間隔（ミリ秒）
  CIRCUIT_BREAKER_THRESHOLD: 3,  // 連続失敗でサーキットブレーカー発動
  WAV_HEADER_SIZE: 44            // WAVヘッダーサイズ（バイト）
};
```

### 話者一覧

| キー | ID | 名前 | 説明 |
|------|----|----|------|
| zundamon | 3 | ずんだもん（ノーマル） | 親しみやすい声 |
| no7-reading | 31 | No.7（読み聞かせ） | 朗読に特化した落ち着いた男性声 |
| aoyama-calm | 84 | 青山龍星（しっとり） | 落ち着いた朗読向け男性声 |
